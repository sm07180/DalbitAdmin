<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.menu.dao.Men_RankDao" >

    <select id="callMainDjRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.menu.vo.procedure.P_MainDjRankingVo">
        call rd_data.sp_ranking_dj(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callMainFanRanking" statementType="CALLABLE" parameterType="ProcedureVo" resultType="com.dalbit.menu.vo.procedure.P_MainFanRankingVo">
        call rd_data.sp_ranking_fan(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="getDjLiveCheck" parameterType="com.dalbit.menu.vo.DjRankingVo" resultType="com.dalbit.menu.vo.DjRankingVo">
        /* Men_Rank.xml - getDjLiveCheck */
        select count(*) as liveCnt, max(upd_date) as liveDate
        <if test='rankType == "1"'>
            from rd_data.tb_ranking_dj_live_data_day where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{sDate}, ' 23:59:59')
        </if>
        <if test='rankType == "2"'>
            from rd_data.tb_ranking_dj_live_data_week where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
        </if>
        <if test='rankType == "3"'>
            from rd_data.tb_ranking_dj_live_data_month where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
        </if>
        <if test='rankType == "4"'>
            from rd_data.tb_ranking_dj_live_data_year where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
        </if>
        <if test='rankType == "5"'>
            from rd_data.tb_ranking_time_dj_live_data
           <!--where date_format(upd_date,'%Y.%m.%d') <![CDATA[ >= ]]> #{sDate} and date_format(upd_date,'%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}-->
            <if test='timeRound == 1'>
                where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{sDate}, ' 10:00:00')
            </if>
            <if test='timeRound == 2'>
                where upd_date between concat(#{sDate}, ' 10:00:00') and concat(#{sDate}, ' 19:00:00')
            </if>
            <if test='timeRound == 3'>
                where upd_date between concat(#{sDate}, ' 19:00:00') and concat(#{sDate}, ' 23:59:59')
            </if>
        </if>
    </select>

    <select id="getFanLiveCheck" parameterType="com.dalbit.menu.vo.FanRankingVo" resultType="com.dalbit.menu.vo.FanRankingVo">
        /* Men_Rank.xml - getFanLiveCheck */
        select count(*) as liveCnt, max(upd_date) as liveDate
        <if test='rankType == "1"'>
            from rd_data.tb_ranking_fan_live_data_day where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{sDate}, ' 23:59:59')
        </if>
        <if test='rankType == "2"'>
            from rd_data.tb_ranking_fan_live_data_week where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
        </if>
        <if test='rankType == "3"'>
            from rd_data.tb_ranking_fan_live_data_month where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
        </if>
        <if test='rankType == "4"'>
            from rd_data.tb_ranking_fan_live_data_year where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
        </if>
        <if test='rankType == "5"'>
            from rd_data.tb_ranking_time_fan_live_data
           <!--where date_format(upd_date,'%Y.%m.%d') <![CDATA[ >= ]]> #{sDate} and date_format(upd_date,'%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}-->
            <if test='timeRound == 1'>
                where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{sDate}, ' 10:00:00')
            </if>
            <if test='timeRound == 2'>
                where upd_date between concat(#{sDate}, ' 10:00:00') and concat(#{sDate}, ' 19:00:00')
            </if>
            <if test='timeRound == 3'>
                where upd_date between concat(#{sDate}, ' 19:00:00') and concat(#{sDate}, ' 23:59:59')
            </if>
        </if>
        <!--select count(*) as liveCnt, max(ranking_date) as liveDate from rd_data.tb_ranking_fan_live where date_format(ranking_date,'%Y.%m.%d') = #{sDate}-->
    </select>

    <sql id="djCondition">
        from
          <if test='rankType == "1"'>
              <if test='liveCnt != 0'>
                rd_data.tb_ranking_dj_live_data_day dj
              </if>
              <if test='liveCnt == 0'>
                rd_data.tb_ranking_dj_day dj
              </if>
          </if>
          <if test='rankType == "2"'>
              <if test='liveCnt != 0'>
                rd_data.tb_ranking_dj_live_data_week dj
              </if>
              <if test='liveCnt == 0'>
                rd_data.tb_ranking_dj_week dj
              </if>
          </if>
          <if test='rankType == "3"'>
              <if test='liveCnt != 0'>
                  rd_data.tb_ranking_dj_live_data_month dj
              </if>
              <if test='liveCnt == 0'>
                  rd_data.tb_ranking_dj_month dj
              </if>
          </if>
          <if test='rankType == "4"'>
              <if test='liveCnt != 0'>
                  rd_data.tb_ranking_dj_live_data_year dj
              </if>
              <if test='liveCnt == 0'>
                  rd_data.tb_ranking_dj_year dj
              </if>
          </if>
          <if test='rankType == "5"'>
              <if test='liveCnt != 0'>
                  rd_data.tb_ranking_time_dj_live_data dj
              </if>
              <if test='liveCnt == 0'>
                  rd_data.tb_ranking_time_dj dj
              </if>
          </if>
          inner join rd_data.tb_member_profile prof on prof.mem_no = dj.mem_no
          inner join  rd_data.tb_member_level lev on prof.mem_no = lev.mem_no
          left join rd_data.tb_member_basic mem on prof.mem_no = mem.mem_no
          left join rd_admin.tb_admin_test_account test on prof.mem_no = test.mem_no

          <if test='rankType == "1"'>
           <if test='liveCnt != 0'>
               where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{sDate}, ' 23:59:59')
           </if>
            <if test='liveCnt == 0'>
               where dj.ranking_date <![CDATA[ = ]]> #{sDate}
            </if>
          </if>
          <if test='rankType == "5"'>
              <if test='liveCnt != 0'>
                  <if test='timeRound == 1'>
                      where dj.upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{sDate}, ' 10:00:00')
                  </if>
                  <if test='timeRound == 2'>
                      where dj.upd_date between concat(#{sDate}, ' 10:00:00') and concat(#{sDate}, ' 19:00:00')
                  </if>
                  <if test='timeRound == 3'>
                      where dj.upd_date between concat(#{sDate}, ' 19:00:00') and concat(#{sDate}, ' 23:59:59')
                  </if>
              </if>
              <if test='liveCnt == 0'>
               where dj.ranking_date <![CDATA[ = ]]> #{sDate}
                 and dj.time_round = ${timeRound}
              </if>
          </if>
          <if test='rankType == "2" or rankType == "3" or rankType == "4"'>
            <if test='liveCnt != 0'>
                where dj.upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
            </if>
            <if test='liveCnt == 0'>
               where dj.ranking_date = #{sDate}
            </if>
          </if>

          AND (test.is_admin IS NULL OR test.is_admin = 0)

          <if test='txt_search != null and txt_search != ""'>
              <choose>
                  <when test='selectGubun =="1"'>
                      and mem.mem_no like concat('%', #{txt_search}, '%')
                  </when>
                  <when test='selectGubun =="2"'>
                      and mem_id like concat('%', #{txt_search}, '%')
                  </when>
                  <when test='selectGubun =="3"'>
                      and mem_nick like concat('%', #{txt_search}, '%')
                  </when>
                  <when test='selectGubun =="4"'>
                      and mem.mem_phone like concat('%', #{txt_search}, '%')
                  </when>
                  <otherwise>
                      and (mem.mem_no = #{txt_search}
                      or mem_id = #{txt_search}
                      or mem_nick like concat('%', #{txt_search}, '%')
                      or mem.mem_phone = #{txt_search})
                  </otherwise>
              </choose>
          </if>
    </sql>

    <sql id="fanCondition">
        from
        <if test='rankType == "1"'>
            <if test='liveCnt != 0'>
                rd_data.tb_ranking_fan_live_data_day fan
            </if>
            <if test='liveCnt == 0'>
                rd_data.tb_ranking_fan_day fan
            </if>
        </if>
        <if test='rankType == "2"'>
            <if test='liveCnt != 0'>
                rd_data.tb_ranking_fan_live_data_week fan
            </if>
            <if test='liveCnt == 0'>
                 rd_data.tb_ranking_fan_week fan
            </if>
        </if>
        <if test='rankType == "3"'>
            <if test='liveCnt != 0'>
                rd_data.tb_ranking_fan_live_data_month fan
            </if>
            <if test='liveCnt == 0'>
                rd_data.tb_ranking_fan_month fan
            </if>
        </if>
        <if test='rankType == "4"'>
            <if test='liveCnt != 0'>
                rd_data.tb_ranking_fan_live_data_year fan
            </if>
            <if test='liveCnt == 0'>
                rd_data.tb_ranking_fan_year fan
            </if>
        </if>
        <if test='rankType == "5"'>
            <if test='liveCnt != 0'>
                rd_data.tb_ranking_time_fan_live_data fan
            </if>
            <if test='liveCnt == 0'>
                rd_data.tb_ranking_time_fan fan
            </if>
        </if>
        left join rd_data.tb_member_basic mem on fan.mem_no = mem.mem_no
        left join rd_admin.tb_admin_test_account test on fan.mem_no = test.mem_no
        left join rd_data.tb_member_profile prof on fan.mem_no = prof.mem_no
        left join rd_data.tb_member_level lev on fan.mem_no = lev.mem_no
        <if test='rankType == "1"'>
            <if test='liveCnt != 0'>
                where fan.upd_date between concat(#{sDate},' 00:00:00') and concat(#{sDate},' 23:59:59')
            </if>
            <if test='liveCnt == 0'>
                where fan.ranking_date = #{sDate}
            </if>
        </if>
        <if test='rankType == "5"'>
            <if test='liveCnt != 0'>
                <if test='liveCnt != 0'>
                    <if test='timeRound == 1'>
                        where fan.upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{sDate}, ' 10:00:00')
                    </if>
                    <if test='timeRound == 2'>
                        where fan.upd_date between concat(#{sDate}, ' 10:00:00') and concat(#{sDate}, ' 19:00:00')
                    </if>
                    <if test='timeRound == 3'>
                        where fan.upd_date between concat(#{sDate}, ' 19:00:00') and concat(#{sDate}, ' 23:59:59')
                    </if>
                </if>
            </if>
            <if test='liveCnt == 0'>
                where fan.ranking_date <![CDATA[ = ]]> #{sDate}
                and fan.time_round = ${timeRound}
            </if>
        </if>
        <if test='rankType == "2" or rankType == "3" or rankType == "4"'>
            <if test='liveCnt != 0'>
                where fan.upd_date between concat(#{sDate},' 00:00:00') and concat(#{eDate},' 23:59:59')
            </if>
            <if test='liveCnt == 0'>
                where fan.ranking_date = #{sDate}
            </if>
        </if>

        AND (test.is_admin IS NULL OR test.is_admin = 0)

        <if test='txt_search != null and txt_search != ""'>
            and (mem.mem_no = #{txt_search}
            or mem_id = #{txt_search}
            or mem_nick like concat('%', #{txt_search}, '%')
            or mem.mem_phone = #{txt_search})
        </if>

    </sql>
    <!-- DJ -->
    <select id="getMainDjRankingList" parameterType="com.dalbit.menu.vo.DjRankingVo" resultType="com.dalbit.menu.vo.DjRankingVo">
        /* Men_Rank.xml - getMainDjRankingList */
        select *
          from (
            select *
                <if test='liveCnt != 0'>
                  , @RNUM := @RNUM + 1 as djRank
                </if>
                <if test='liveCnt == 0'>
                  , @RNUM := @RNUM + 1 as rowNum
                </if>
            from (
              select
                <if test='liveCnt != 0'>
                    1 as rowNum
                    , '' as upDown
                    , dj.upd_date as ranking_date
                </if>
                <if test='liveCnt == 0'>
                    dj.rank as djRank
                    , dj.up_down as upDown
                    , dj.ranking_date as ranking_date
                </if>
                , dj.mem_no as memNo
                , prof.image_profile as image_profile
                , mem.mem_id as mem_id
                , lev.`level` as `level`
                , lev.grade as grade
                , mem.mem_nick as mem_nick
                , mem.mem_sex as mem_sex
                , mem.mem_birth_year
                , mem.mem_birth_month
                , mem.mem_birth_day
                , mem.inner
                , (select sum(ifnull(money,0)) from rd_data.tb_member_wallet where mem_no = mem.mem_no) as money
                <!--, (select ifnull(sum(ifnull(gold, 0)), 0) from rd_data.tb_member_broadcast_item item where item.gifted_mem_no = mem.mem_no and item_type = 1) as byeol-->
                , dj.booster_point as boostCnt
                , (dj.booster_point * 10) as boostByeol
                <!--, (select count(if(gifted_mem_no!=0, gifted_mem_no, null)) from rd_data.tb_member_broadcast_item where mem_no = mem.mem_no) as gifted_mem_no-->
                <!--, (select count(if(mem_no!=0, mem_no, null)) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as airCount-->
                <!--, (select min(start_date) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as start_date-->
                <if test='liveCnt != 0'>
                    <!--, @liveTime := ifnull((select TIMESTAMPDIFF( SECOND, start_date, NOW() ) from rd_data.tb_broadcast_room_live_list where mem_no = dj.mem_no), 0) as liveTime-->
                    , ROUND((dj.broadcast_point + @liveTime )) AS airTime
                </if>
                <if test='liveCnt == 0'>
                  , dj.broadcast_point as airTime
                </if>
                , CAST(dj.good_point AS INT) as goodCnt
                , CAST(dj.dj_point AS INT) AS rankPoint
                , dj.listener_point as listenCnt
                , dj.gift_point as itemCnt
                , (select count(*) from rd_data.tb_member_dalbitaward_dj_list where mem_no = mem.mem_no and select_year = date_format(#{sDate},'%Y')) AS awards
                <if test='rankType == "1"'>
                    ,(select badge_value From rd_data.tb_member_badge where slct_type=3 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                       union
                      select badge_value From rd_data.tb_member_badge_history where slct_type=3 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                    ) as reward_rank
                    ,(select date_format(start_date , '%Y.%m.%d %H:%i:%s' ) From rd_data.tb_member_badge where slct_type=3 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                       union
                      select date_format(start_date , '%Y.%m.%d %H:%i:%s' ) From rd_data.tb_member_badge_history where slct_type=3 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                    ) as rewardStartDate
                    ,(select date_format(end_date , '%Y.%m.%d' ) From rd_data.tb_member_badge where slct_type=3 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                       union
                      select date_format(end_date , '%Y.%m.%d' ) From rd_data.tb_member_badge_history where slct_type=3 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                    ) as rewardEndDate
                    ,(select ranking_date from rd_data.tb_member_ranking_reward_dj where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_date
                    ,(select reward_dal from rd_data.tb_member_ranking_reward_dj where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_dal
                    ,(select reward_byeol from rd_data.tb_member_ranking_reward_dj where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_byeol
                    ,(select reward_exp from rd_data.tb_member_ranking_reward_dj where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_exp
                    ,(select reward_yn from rd_data.tb_member_ranking_reward_dj where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_yn
                    ,'1' as ranking_type
                    ,(select date_format(last_upd_date, '%Y.%m.%d %H:%i:%s' ) from rd_data.tb_member_ranking_reward_dj where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as rewardLastUpdDate
                    ,(select image
                       from rd_data.tbl_badge_info
                      where slct_type=3
                        and `value` in ( select badge_value From rd_data.tb_member_badge where slct_type=3 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                                          union
                                         select badge_value From rd_data.tb_member_badge_history where slct_type=3 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                      )) as badgeImage
                </if>
                <if test='rankType == "2"'>
                    ,(select badge_value From rd_data.tb_member_badge where slct_type=5 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                       union
                      select badge_value From rd_data.tb_member_badge_history where slct_type=5 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                    ) as reward_rank
                    ,(select date_format(start_date , '%Y.%m.%d %H:%i:%s' ) From rd_data.tb_member_badge where slct_type=5 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                       union
                      select date_format(start_date , '%Y.%m.%d %H:%i:%s' ) From rd_data.tb_member_badge_history where slct_type=5 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                    ) as rewardStartDate
                    ,(select date_format(end_date, '%Y.%m.%d' ) From rd_data.tb_member_badge where slct_type=5 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                       union
                      select date_format(end_date, '%Y.%m.%d' ) From rd_data.tb_member_badge_history where slct_type=5 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                    ) as rewardEndDate
                    ,(select ranking_date from rd_data.tb_member_ranking_reward_dj where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_date
                    ,(select reward_dal from rd_data.tb_member_ranking_reward_dj where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_dal
                    ,(select reward_byeol from rd_data.tb_member_ranking_reward_dj where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_byeol
                    ,(select reward_exp from rd_data.tb_member_ranking_reward_dj where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_exp
                    ,(select reward_yn from rd_data.tb_member_ranking_reward_dj where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_yn
                    ,(select ranking_type from rd_data.tb_member_ranking_reward_dj where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as ranking_type
                    ,(select date_format(last_upd_date, '%Y.%m.%d %H:%i:%s' ) from rd_data.tb_member_ranking_reward_dj where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as rewardLastUpdDate
                    ,(select image
                        from rd_data.tbl_badge_info
                       where slct_type=5
                         and `value` in (select badge_value From rd_data.tb_member_badge where slct_type=5 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                                          union
                                         select badge_value From rd_data.tb_member_badge_history where slct_type=5 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                      )) as badgeImage
                </if>
                <if test='rankType == "3" or rankType == "4"'>
                    ,'' as reward_rank
                    ,'' as rewardStartDate
                    ,'' as rewardEndDate
                    ,'' as reward_date
                    ,'' as reward_dal
                    ,'' as reward_byeol
                    ,'' as reward_exp
                    ,'' as reward_yn
                    ,'' as ranking_type
                    ,'' as rewardLastUpdDate
                    ,'' as badgeImage
                </if>
              <include refid="djCondition"/>
            ) a , (select @RNUM := 0) r
            order by rankPoint desc
        ) b

        limit #{pageStart}, #{pageCnt}
        <!--where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}-->
    </select>

    <select id="getMainDjRankingListCnt" parameterType="com.dalbit.menu.vo.DjRankingVo" resultType="integer">
        /* Men_Rank.xml - getMainDjRankingListCnt */
        select
        count(*)
        <include refid="djCondition"/>
    </select>


    <!-- fan -->
    <select id="getMainFanRankingList" parameterType="com.dalbit.menu.vo.FanRankingVo" resultType="com.dalbit.menu.vo.FanRankingVo">
        /* Men_Rank.xml - getMainFanRankingList */
        select *
            from (
              select *
                <if test='liveCnt != 0'>
                    , @RNUM := @RNUM + 1 as fanRank
                </if>
                <if test='liveCnt == 0'>
                    , @RNUM := @RNUM + 1 as rowNum
                </if>
                from (
                    select
                        <!--fan.fan_point as fanRank-->
                        <if test='liveCnt != 0'>
                            '' as upDown
                            , fan.upd_date as ranking_date
                        </if>
                        <if test='liveCnt == 0'>
                            fan.rank as fanRank
                            , fan.up_down as upDown
                            , fan.ranking_date as ranking_date
                        </if>
                        , prof.image_profile as image_profile
                        , mem.mem_id as mem_id
                        , mem.mem_no as mem_no
                        , lev.`level` as `level`
                        , lev.grade as grade
                        , mem.mem_nick as mem_nick
                        , mem.mem_sex as mem_sex
                        , mem.mem_birth_year
                        , mem.mem_birth_month
                        , mem.mem_birth_day
                        , mem.inner
                        , (select sum(ifnull(money,0)) from rd_data.tb_member_wallet where mem_no = mem.mem_no) as money
                        <!--, (select ifnull(sum(ifnull(gold, 0)), 0) from rd_data.tb_member_broadcast_item item where item.mem_no = mem.mem_no and item_type = 1) as byeol-->
                        , fan.good_point as goodCnt
                        , fan.booster_point as boostCnt
                        , (fan.booster_point * 20) as boostDal
                        <!--, (select count(if(gifted_mem_no!=0, gifted_mem_no, null)) from rd_data.tb_member_broadcast_item where mem_no = mem.mem_no) as gifted_mem_no-->
                        <!--, (select count(if(mem_no!=0, mem_no, null)) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as airCount-->
                        <!--, (select min(start_date) from rd_data.tb_member_broadcast_broadcasting where mem_no = mem.mem_no) as start_date-->
                        , fan.listen_point as airTime
                        , CAST(fan.fan_point AS INT) AS rankPoint
                        , fan.gift_point as itemCnt
                        , (select count(*) from rd_data.tb_member_dalbitaward_fan_list where mem_no = mem.mem_no and select_year = date_format(#{sDate},'%Y')) AS awards
                        <if test='rankType == "1"'>
                            ,(select badge_value From rd_data.tb_member_badge where slct_type=2 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                               union
                              select badge_value From rd_data.tb_member_badge_history where slct_type=2 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                            ) as reward_rank
                            ,(select date_format(start_date, '%Y.%m.%d %H:%i:%s' ) From rd_data.tb_member_badge where slct_type=2 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                               union
                              select date_format(start_date, '%Y.%m.%d %H:%i:%s' ) From rd_data.tb_member_badge_history where slct_type=2 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                            ) as rewardStartDate
                            ,(select date_format(end_date, '%Y.%m.%d' ) From rd_data.tb_member_badge where slct_type=2 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                               union
                              select date_format(end_date, '%Y.%m.%d' ) From rd_data.tb_member_badge_history where slct_type=2 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                            ) as rewardEndDate
                            ,(select ranking_date from rd_data.tb_member_ranking_reward_fan where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_date
                            ,(select reward_dal from rd_data.tb_member_ranking_reward_fan where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_dal
                            ,(select reward_byeol from rd_data.tb_member_ranking_reward_fan where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_byeol
                            ,(select reward_exp from rd_data.tb_member_ranking_reward_fan where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_exp
                            ,(select reward_yn from rd_data.tb_member_ranking_reward_fan where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as reward_yn
                            ,(select ranking_type from rd_data.tb_member_ranking_reward_fan where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as ranking_type
                            ,(select date_format(last_upd_date, '%Y.%m.%d %H:%i:%s' ) from rd_data.tb_member_ranking_reward_fan where ranking_type=1 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') = #{sDate}) as rewardLastUpdDate
                            ,(select image
                                from rd_data.tbl_badge_info
                               where slct_type=2
                                 and `value` in (select badge_value From rd_data.tb_member_badge where slct_type=2 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                                                  union
                                                 select badge_value From rd_data.tb_member_badge_history where slct_type=2 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') = #{sDate}
                            )) as badgeImage
                        </if>
                        <if test='rankType == "2"'>
                            ,(select badge_value From rd_data.tb_member_badge where slct_type=4 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                               union
                              select badge_value From rd_data.tb_member_badge_history where slct_type=4 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                            ) as reward_rank
                            ,(select date_format(start_date, '%Y.%m.%d %H:%i:%s' ) From rd_data.tb_member_badge where slct_type=4 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                               union
                              select date_format(start_date, '%Y.%m.%d %H:%i:%s' )  From rd_data.tb_member_badge_history where slct_type=4 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                            ) as rewardStartDate
                            ,(select date_format(end_date, '%Y.%m.%d' )  From rd_data.tb_member_badge where slct_type=4 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                               union
                              select date_format(end_date, '%Y.%m.%d' )  From rd_data.tb_member_badge_history where slct_type=4 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                            ) as rewardEndDate
                            ,(select ranking_date from rd_data.tb_member_ranking_reward_fan where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_date
                            ,(select reward_dal from rd_data.tb_member_ranking_reward_fan where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_dal
                            ,(select reward_byeol from rd_data.tb_member_ranking_reward_fan where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_byeol
                            ,(select reward_exp from rd_data.tb_member_ranking_reward_fan where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_exp
                            ,(select reward_yn from rd_data.tb_member_ranking_reward_fan where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as reward_yn
                            ,(select ranking_type from rd_data.tb_member_ranking_reward_fan where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as ranking_type
                            ,(select date_format(last_upd_date, '%Y.%m.%d %H:%i:%s' ) from rd_data.tb_member_ranking_reward_fan where ranking_type=2 and mem_no=mem.mem_no and date_format(last_upd_date, '%Y.%m.%d') >= #{sDate} and date_format(last_upd_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}) as rewardLastUpdDate
                            ,(select image
                                from rd_data.tbl_badge_info
                               where slct_type=4
                                 and `value` in (select badge_value From rd_data.tb_member_badge where slct_type=4 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                                                  union
                                                 select badge_value From rd_data.tb_member_badge_history where slct_type=4 and mem_no=mem.mem_no and date_format(start_date, '%Y.%m.%d') >= #{sDate} and date_format(start_date, '%Y.%m.%d') <![CDATA[ <= ]]> #{eDate}
                              )) as badgeImage
                        </if>
                        <if test='rankType == "3" or rankType == "4"'>
                            ,'' as reward_rank
                            ,'' as rewardStartDate
                            ,'' as rewardEndDate
                            ,'' as reward_date
                            ,'' as reward_dal
                            ,'' as reward_byeol
                            ,'' as reward_exp
                            ,'' as reward_yn
                            ,'' as ranking_type
                            ,'' as rewardLastUpdDate
                            ,'' as badgeImage
                        </if>

                    <include refid="fanCondition"/>
                    ) a , (select @RNUM := 0) r
                    order by rankPoint desc
                ) b
        limit #{pageStart}, #{pageCnt}
        <!--where rowNum between #{searchStartNo, jdbcType=INTEGER} and #{searchEndNo, jdbcType=INTEGER}-->
    </select>

    <select id="getMainFanRankingListCnt" parameterType="com.dalbit.menu.vo.FanRankingVo" resultType="integer">
        /* Men_Rank.xml - getMainFanRankingListCnt */
        select
          count(*)
        <include refid="fanCondition"/>
    </select>




    <select id="getAddDjLiveCheck" parameterType="com.dalbit.menu.vo.AddDjPointVo" resultType="com.dalbit.menu.vo.AddDjPointVo">
        /* Men_Rank.xml - AddDjPointVo */
        select count(*) as liveCnt, max(upd_date) as liveDate
          from rd_data.tb_ranking_dj_live_data_month
         where upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{sDate}, ' 23:59:59')
    </select>

    <sql id="addDjPointCondition">
        from
        <if test='liveCnt != 0'>
            rd_data.tb_ranking_dj_live_data_month dj
        </if>
        <if test='liveCnt == 0'>
            rd_data.tb_ranking_dj_month dj
        </if>
        inner join rd_data.tb_member_profile prof on prof.mem_no = dj.mem_no
        inner join  rd_data.tb_member_level lev on prof.mem_no = lev.mem_no
        left join rd_data.tb_member_basic mem on prof.mem_no = mem.mem_no
        left join rd_admin.tb_admin_test_account test on prof.mem_no = test.mem_no
        <if test='liveCnt != 0'>
            where dj.upd_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
        </if>
        <if test='liveCnt == 0'>
            where dj.ranking_date = #{sDate}
        </if>
        AND (test.is_admin IS NULL OR test.is_admin = 0)
        <if test='txt_search != null and txt_search != ""'>
            <choose>
                <when test='selectGubun =="1"'>
                    and mem.mem_no = #{txt_search}
                </when>
                <when test='selectGubun =="2"'>
                    and mem_id = #{txt_search}
                </when>
                <when test='selectGubun =="3"'>
                    and mem_nick like concat('%', #{txt_search}, '%')
                </when>
                <when test='selectGubun =="4"'>
                    and mem.mem_phone = #{txt_search}
                </when>
                <otherwise>
                    and (mem.mem_no = #{txt_search}
                    or mem_id = #{txt_search}
                    or mem_nick like concat('%', #{txt_search}, '%')
                    or mem.mem_phone = #{txt_search})
                </otherwise>
            </choose>
        </if>
    </sql>

    <select id="getAddDjPointList" parameterType="com.dalbit.menu.vo.DjRankingVo" resultType="com.dalbit.menu.vo.AddDjPointVo">
        /* Men_Rank.xml - getAddDjPointList */
        select *
              ,@RNUM := @RNUM + 1 as rowNum
          from (
                select *
                ,addPointRank1 * 1.5 as addPoint1
                ,addPointRank2 * 0.5 as addPoint2
                ,addPointRank3 * 0.3 as addPoint3
                ,(addPointRank1 * 1.5) + (addPointRank2 * 0.5) + (addPointRank3 * 0.3) as addPointTotal
                from (
                      select dj.mem_no as memNo
                        , prof.image_profile as image_profile
                        , mem.mem_id as mem_id
                        , lev.`level` as `level`
                        , lev.grade as grade
                        , mem.mem_nick as mem_nick
                        , mem.mem_sex as mem_sex
                        , mem.mem_birth_year
                        , mem.inner
                        , CAST(dj.dj_point AS INT) AS rankPoint
                        , (select count(*)
                             from rd_data.tb_ranking_time_dj
                            where mem_no = dj.mem_no
                              and `rank`=1
                              and ranking_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
                          ) as addPointRank1
                        , (select count(*)
                             from rd_data.tb_ranking_time_dj
                            where mem_no = dj.mem_no
                              and `rank`=2
                              and ranking_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
                          ) as addPointRank2
                        , (select count(*)
                             from rd_data.tb_ranking_time_dj
                            where mem_no = dj.mem_no
                              and `rank`=3
                              and ranking_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
                          ) as addPointRank3
                        <include refid="addDjPointCondition"/>

                  ) a , (select @RNUM := #{pageStart}) r
             where addPointRank1 > 0 or addPointRank2 > 0 or addPointRank3 > 0
            order by addPointTotal desc, rankPoint desc
        ) b
        limit #{pageStart}, #{pageCnt}
    </select>

    <select id="getAddDjPointListCnt" parameterType="com.dalbit.menu.vo.DjRankingVo" resultType="integer">
        /* Men_Rank.xml - getAddDjPointListCnt */
        select count(*)
          from (
                select *
                ,addPointRank1 * 1.5 as addPoint1
                ,addPointRank2 * 0.5 as addPoint2
                ,addPointRank3 * 0.3 as addPoint3
                ,(addPointRank1 * 1.5) + (addPointRank2 * 0.5) + (addPointRank3 * 0.3) as addPointTotal
                from (
                      select dj.mem_no as memNo
                        , prof.image_profile as image_profile
                        , mem.mem_id as mem_id
                        , lev.`level` as `level`
                        , lev.grade as grade
                        , mem.mem_nick as mem_nick
                        , mem.mem_sex as mem_sex
                        , mem.mem_birth_year
                        , mem.inner
                        , CAST(dj.dj_point AS INT) AS rankPoint
                        , (select count(*)
                             from rd_data.tb_ranking_time_dj
                            where mem_no = dj.mem_no
                              and `rank`=1
                              and ranking_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
                          ) as addPointRank1
                        , (select count(*)
                             from rd_data.tb_ranking_time_dj
                            where mem_no = dj.mem_no
                              and `rank`=2
                              and ranking_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
                          ) as addPointRank2
                        , (select count(*)
                             from rd_data.tb_ranking_time_dj
                            where mem_no = dj.mem_no
                              and `rank`=3
                              and ranking_date between concat(#{sDate}, ' 00:00:00') and concat(#{eDate}, ' 23:59:59')
                          ) as addPointRank3
                        <include refid="addDjPointCondition"/>

                  ) a , (select @RNUM := #{pageStart}) r
             where addPointRank1 > 0 or addPointRank2 > 0 or addPointRank3 > 0
            order by addPointTotal desc, rankPoint desc
        ) b
    </select>


    <select id="callGetGoodRank" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.menu.vo.GoodRankVo">
        call rd_admin.sp_admin_good_ranking_list(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAwardsVote" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.menu.vo.AwardsVoteVo">
        call rd_admin.sp_admin_member_dalbitaward_vote_list(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAwardsVoteMember" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.menu.vo.AwardsVoteVo">
        call rd_admin.sp_admin_member_dalbitaward_vote_member(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAwardsVoteDetail" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.menu.vo.AwardsVoteVo">
        call rd_admin.sp_admin_member_dalbitaward_vote_detail(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAwardsRegist" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.common.vo.ProcedureVo">
        call rd_admin.sp_admin_member_dalbitaward_regist(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAwardsDj" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.menu.vo.AwardsVoteVo">
        call rd_admin.sp_admin_member_dalbitaward_dj_final(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAwardsFan" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.menu.vo.AwardsVoteVo">
        call rd_admin.sp_admin_member_dalbitaward_fan_final(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAwardsDjRegist" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.common.vo.ProcedureVo">
        call rd_admin.sp_admin_member_dalbitaward_dj_final_edit(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAwardsDjSelImpression" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.common.vo.ProcedureVo">
        call rd_admin.sp_admin_member_dalbitaward_msg_detail(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callAwardsDjImpression" statementType="CALLABLE" parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.common.vo.ProcedureVo">
        call rd_admin.sp_admin_member_dalbitaward_msg_edit(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

</mapper>