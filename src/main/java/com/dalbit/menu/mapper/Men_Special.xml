<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dalbit.menu.dao.Men_SpecialDao" >

    <select id="summary" parameterType="com.dalbit.menu.vo.SpecialSummaryVo" resultType="com.dalbit.menu.vo.SpecialSummaryVo">
        /* Men_Special.xml - summary */
        select
            (select
                count(*)
                from rd_admin.tb_req_special_dj redj
                inner join rd_data.tb_member_basic mem
                    on redj.mem_no = mem.mem_no
                    and concat(#{select_year}, #{select_month}) = DATE_FORMAT(redj.reg_date, '%Y%m')
                where redj.state <![CDATA[<>]]> 2
            ) as requestDal
        , (select
            count(*)
            from rd_admin.tb_special_dj dj
            inner join rd_data.tb_member_basic mem
                on dj.mem_no = mem.mem_no
                where 1=1
                <if test='select_year != null and select_year != ""' >
                    and dj.select_year = #{select_year}
                </if>
                <if test='select_month != null and select_month != ""' >
                    and dj.select_month = #{select_month}
                </if>
        ) as approveDal
    </select>

    <sql id="reqSpecial">

        <if test='txt_search != null and txt_search != ""'>
            <choose>
                <when test="newSearchType == 1">
                    and dj.mem_no = #{txt_search}
                </when>
                <when test="newSearchType == 2">
                    and basic.mem_nick like concat('%', #{txt_search}, '%')
                </when>
                <when test="newSearchType == 3">
                    and basic.mem_name = #{txt_search}
                </when>
                <when test="newSearchType == 4">
                    and basic.mem_phone = #{txt_search}
                </when>
                <when test="newSearchType == 5">
                    and basic.mem_id = #{txt_search}
                </when>
                <when test="newSearchType == 6">
                    and dj.mem_no in (select distinct mem_no from rd_data.tb_member_connect_state where last_login_ip = #{txt_search})
                </when>
                <otherwise>
                    and dj.mem_no in (SELECT distinct mem_no FROM rd_data.tb_member_session_history WHERE device_uuid = #{txt_search})
                </otherwise>
            </choose>
        </if>
    </sql>

    <select id="getReqSpecialList" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - getReqSpecialList */
        select
            *
        from (
        select
            dj.idx as idx
            , dj.mem_no as mem_no
            , dj.mem_name as mem_name
            , dj.mem_phone as mem_phone
            , dj.title as title
            , dj.reg_date as reg_date
            , dj.contents as contents
            , dj.broadcast_time1 as broadcast_time1
            , dj.broadcast_time2 as broadcast_time2
            , dj.state as state
            , dj.op_name as op_name
            , dj.last_upd_date as last_upd_date
            , profile.specialdj_badge as specialdj_badge
            , basic.mem_id as mem_id
            , basic.mem_nick as mem_nick
            , basic.mem_sex
            , basic.mem_birth_year
            , basic.mem_birth_month
            , basic.mem_birth_day
            , basic.inner
            , @RNUM := @RNUM + 1 as rowNum
            , ifnull((select TRUNCATE(ifnull(sum(airtime), 0) / 60, 0)
                        from rd_data.tb_broadcast_room room
                        where mem_no = basic.mem_no
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>start_date
                        and start_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) airTime
            , ifnull((select count(*)
                        from rd_data.tb_broadcast_room room
                        where mem_no = basic.mem_no
                        and 5400<![CDATA[<=]]>airtime
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>start_date
                        and start_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) broadcastCnt
            , ifnull((select sum(good)
                        from rd_data.tb_member_broadcast_broadcasting
                        where mem_no = basic.mem_no
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                        and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) goodCnt
            , ifnull((select sum(booster) * 10
                        from rd_data.tb_member_broadcast_broadcasting
                        where mem_no = basic.mem_no
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                        and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) boostGoodCnt
            /*, ifnull((select count(*)
                        from rd_data.tb_member_fanstar
                        where mem_no_star = basic.mem_no), 0) fanCnt*/
            , ifnull((select sum(listener)
                        from rd_data.tb_member_broadcast_broadcasting
                        where mem_no = basic.mem_no
                            and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                            and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) allListenCnt
            , ifnull((select count(distinct listen.mem_no)
                        from rd_data.tb_member_broadcast_listening listen
                        where dj_mem_no = basic.mem_no
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>last_upd_date
                        and last_upd_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) listenCnt
            , ifnull((select count(*)
                        from rd_data.tb_member_report report
                        where reported_mem_no = basic.mem_no
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>report.reg_date
                        and report.reg_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) reportCnt
            , ifnull((select sum(gold)
                        from rd_data.tb_member_broadcast_broadcasting broad
                        where broad.mem_no = basic.mem_no
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>last_upd_date
                        and last_upd_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) receiveStar
            /*, ifnull((select count(*)
                        from rd_data.tb_broadcast_room room
                        , rd_data.tb_broadcast_room_msg msg
                        where dj.mem_no = room.mem_no
                        and room.room_no = msg.room_no
                        and msg.type = 'chat'
                        and msg.category = 'chat.chat'
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00')<![CDATA[<=]]>msg.last_upd_date
                        and msg.last_upd_date<![CDATA[<=]]>DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) chatCnt*/
            , ifnull((select count(*)
                        from rd_data.tb_broadcast_room room
                        where dj.mem_no = room.mem_no
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> room.start_date
                        and room.start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) broadCnt
            , ifnull((select count(distinct listen.mem_no)
                        from rd_data.tb_member_broadcast_listening listen
                        where dj.mem_no = listen.dj_mem_no
                        and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> listen.start_date
                        and listen.start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')
                        and 1800 <![CDATA[<=]]> listen.listentime), 0) listenCnt30
            , profile.specialdj_cnt specialCnt
        from rd_admin.tb_req_special_dj dj
            , rd_data.tb_member_profile profile
            , rd_data.tb_member_basic basic
            , rd_admin.tb_req_special_dj_manage manage
            , (select @RNUM := 0) r
        where basic.mem_no = dj.mem_no
            and profile.mem_no = dj.mem_no
            and basic.mem_no = profile.mem_no
            and dj.state <![CDATA[<>]]> 2
            <!--and concat(#{select_year}, #{select_month}) = DATE_FORMAT(dj.reg_date, '%Y%m')-->
            and dj.reg_date between concat(#{select_year},'.', #{select_month},'.01', ' 00:00:00') and DATE_SUB( DATE_ADD(concat(#{select_year},'.', #{select_month},'.01'), INTERVAL 1 MONTH), INTERVAL 1 SECOND )
            and manage.select_year = #{select_year}
            and manage.select_month = #{select_month}
            <include refid="reqSpecial" />
        order by idx desc
        ) a
        limit #{pageStart}, #{pageCnt}
    </select>

    <select id="getSpecialDjAddpoint" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="java.lang.Double">
        /* Men_Special.xml - getSpecialDjAddpoint */
        SELECT ifnull(SUM(a.addPoint), 0) as addPoint
        FROM (SELECT (case rank when 1 then 1.5 when 2 then 0.5 when 3 then 0.3 ELSE 0 END) AS addPoint
            FROM rd_data.tb_ranking_time_dj
                , rd_admin.tb_req_special_dj_manage dj_manage
            WHERE dj_manage.select_year = #{select_year}
            and dj_manage.select_month = #{select_month}
            and DATE_FORMAT(dj_manage.condition_start_date, '%Y-%m-%d') <![CDATA[<=]]> DATE_FORMAT(ranking_date, '%Y-%m-%d')
            AND DATE_FORMAT(ranking_date, '%Y-%m-%d') <![CDATA[<=]]> DATE_FORMAT(dj_manage.condition_end_date, '%Y-%m-%d')
            AND mem_no = #{mem_no}
            AND `rank` <![CDATA[<=]]> 3
        ) AS a
    </select>

    <select id="getReqSpecialListCnt" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="integer">
        /* Men_Special.xml - getReqSpecialListCnt */
        select
        count(*)
        from rd_admin.tb_req_special_dj dj
        , rd_data.tb_member_basic basic
        where basic.mem_no = dj.mem_no
        and dj.state <![CDATA[<>]]> 2
        <!--and concat(#{select_year}, #{select_month}) = DATE_FORMAT(dj.reg_date, '%Y%m')-->
        and dj.reg_date between concat(#{select_year},'.', #{select_month},'.01', ' 00:00:00') and DATE_SUB( DATE_ADD(concat(#{select_year},'.', #{select_month},'.01'), INTERVAL 1 MONTH), INTERVAL 1 SECOND )
        <include refid="reqSpecial" />
    </select>

    <select id="getReqSpecialDetail" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - getReqSpecialDetail */
        select
          idx
          , mem_no
          , mem_name
          , mem_phone
          , title
          , reg_date
          , op_name
          , last_upd_date
          , contents
          , broadcast_time1
          , broadcast_time2
          , state
        from rd_admin.tb_req_special_dj
        where idx = #{idx}
    </select>

    <insert id="reqOk" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - reqOk */
        insert into rd_admin.tb_special_dj(
            req_idx
            , mem_no
            , reg_date
            , op_name
            , is_force
            , select_year
            , select_month
            , round_no
            , slct_type
        )values(
            #{idx}
            , #{mem_no}
            , current_timestamp()
            , #{op_name}
            , #{is_force}
            , #{select_year}
            , #{select_month}
            , (select round_no + 1 from rd_admin.tb_req_special_dj_manage where date_format(concat(select_year, select_month, '01'), '%Y-%m') = (select date_format(DATE_SUB(date_format(concat(#{select_year}, #{select_month}, '01'), '%Y-%m-%d'), interval 1 month),  '%Y-%m')))
            , #{slct_type}
        )
    </insert>

    <insert id="opLastUpdDate" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - opLastUpdDate*/
        update rd_admin.tb_req_special_dj
        set last_upd_date = now()
        where mem_no = #{mem_no}
    </insert>

    <update id="reqOkUpdate" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - reqOkUpdate */
      update rd_admin.tb_req_special_dj
      set state = #{state}
        , op_name=#{op_name}
        , last_upd_date = now()
      where idx = #{idx}
    </update>

    <update id="profileUpdate" parameterType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - profileUpdate */
        update rd_data.tb_member_profile
        set specialdj_badge = #{specialdj_badge}
            , specialdj_cnt = specialdj_cnt + #{plusMinusCnt}
        where mem_no = #{mem_no}
    </update>


    <sql id="special">
        <where>
            <if test='select_year != null and select_year != ""' >
                dj.select_year = #{select_year}
            </if>
            <if test='select_month != null and select_month != ""' >
                and dj.select_month = #{select_month}
            </if>

            <if test="isBest == 1">
                and pro.specialdj_badge = 2
            </if>

            <if test='txt_search != null and txt_search != ""'>
                <choose>
                    <when test="newSearchType == 1">
                        and dj.mem_no = #{txt_search}
                    </when>
                    <when test="newSearchType == 2">
                        and (
                            basic.mem_nick like concat('%', #{txt_search})
                            or basic.mem_nick like concat(#{txt_search}, '%')
                        )
                    </when>
                    <when test="newSearchType == 3">
                        and basic.mem_name = #{txt_search}
                    </when>
                    <when test="newSearchType == 4">
                        and basic.mem_phone = #{txt_search}
                    </when>
                    <when test="newSearchType == 5">
                        and basic.mem_id = #{txt_search}
                    </when>
                    <when test="newSearchType == 6">
                        and dj.mem_no in (select distinct mem_no from rd_data.tb_member_connect_state where last_login_ip = #{txt_search})
                    </when>
                    <otherwise>
                        and dj.mem_no in (SELECT distinct mem_no FROM rd_data.tb_member_session_history WHERE device_uuid = #{txt_search})
                    </otherwise>
                </choose>
            </if>
        </where>
    </sql>

    <select id="getSpecialList" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="com.dalbit.menu.vo.SpecialVo">
        /* Men_Special.xml - getSpecialList */
        select *, (a.likeCnt + boostCnt * 10) as totLikeCnt
        from (
            select
                dj.req_idx,
                dj.mem_no,
                dj.reg_date,
                dj.op_name,
                dj.select_year,
                dj.select_month,
                basic.mem_id,
                basic.mem_userid,
                basic.mem_nick,
                basic.mem_sex,
                basic.mem_birth_year,
                basic.mem_birth_month,
                basic.mem_birth_day,
                basic.inner,
                pro.image_profile,
                pro.specialdj_cnt,
                pro.specialdj_badge,
                ifnull(req.mem_name, basic.mem_name) mem_name,
                ifnull(req.mem_phone, basic.mem_phone) mem_phone,
                if(0 <![CDATA[<]]> (pro.specialdj_cnt-5), pro.specialdj_cnt-5, 0) best_cnt,
                (select ifnull(sum(airtime), 0) from rd_data.tb_member_broadcast_broadcasting WHERE mem_no= dj.mem_no) AS airTime,
                (select ifnull(sum(gold), 0) from rd_data.tb_member_broadcast_broadcasting WHERE mem_no= dj.mem_no) AS giftedRuby,
                (select ifnull(sum(good), 0) from rd_data.tb_member_broadcast_broadcasting WHERE mem_no= dj.mem_no) AS likeCnt,
                (select sum(booster) as boostCnt from rd_data.tb_member_broadcast_broadcasting a where mem_no= dj.mem_no) as boostCnt,
                (select count(*) from rd_data.tb_member_report WHERE reported_mem_no = dj.mem_no and op_code in (3,4,5,6) ) as reportCnt
            from rd_admin.tb_special_dj dj
            inner join rd_data.tb_member_basic basic on dj.mem_no = basic.mem_no
            inner join rd_data.tb_member_profile pro on dj.mem_no = pro.mem_no
            left outer join rd_admin.tb_req_special_dj req on dj.mem_no = req.mem_no and concat(dj.select_year,dj.select_month) = date_format(req.reg_date, '%Y%m')
            <include refid="special"/>
            order by `order` asc, dj.reg_date desc
        ) a
        limit 0, 100
    </select>

    <select id="getSpecialListCnt" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="integer">
        /* Men_Special.xml - getSpecialListCnt */
        select
        count(*)
        from rd_admin.tb_special_dj dj
        inner join rd_data.tb_member_basic basic on dj.mem_no = basic.mem_no
        inner join rd_data.tb_member_profile pro on dj.mem_no = pro.mem_no
        left join rd_admin.tb_req_special_dj redj on dj.mem_no = redj.mem_no and dj.req_idx = redj.idx
        <include refid="special"/>
    </select>

    <select id="checkSpecialDjCnt" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="java.util.HashMap">
        /* Men_Special.xml - checkSpecialDjCnt */
        select profile.specialdj_cnt
             , count(dj.mem_no) is_exist
        from rd_data.tb_member_basic basic
                 inner join rd_data.tb_member_profile profile on basic.mem_no = profile.mem_no
                 left join rd_admin.tb_special_dj dj on dj.mem_no = basic.mem_no and dj.select_year = #{select_year} and select_month = #{select_month}
        where basic.mem_no = #{mem_no}
    </select>

    <select id="getSpecialDetail" parameterType="com.dalbit.menu.vo.SpecialVo" resultType="com.dalbit.menu.vo.SpecialVo">
        /* Men_Special.xml - getSpecialDetail */
        select
          dj.req_idx as req_idx
          , dj.mem_no as mem_no
          , dj.reg_date as reg_date
          , dj.is_force as is_force
          , dj.op_name as op_name
          , redj.title as title
          , redj.contents as contents
          , redj.reg_date as request_date
          , dj.select_year as select_year
          , dj.select_month as select_month
        from
          rd_admin.tb_special_dj dj
          left join rd_admin.tb_req_special_dj redj on #{req_idx} = redj.idx and dj.req_idx = redj.idx and dj.mem_no = #{mem_no}
        where dj.mem_no = #{mem_no}
          and dj.select_year = #{select_year}
          and dj.select_month = #{select_month}
    </select>

    <delete id="reqCancel" parameterType="com.dalbit.menu.vo.SpecialVo">
        /* Men_Special.xml - reqCancel */
        delete
        from rd_admin.tb_special_dj
        where mem_no = #{mem_no}
          and select_year = #{select_year}
          and select_month = #{select_month}
    </delete>

    <update id="updateOrder" parameterType="com.dalbit.menu.vo.SpecialDjOrderVo">
        /* Men_Special.xml - updateOrder */
        update rd_admin.tb_special_dj
        set `order` = #{order}
        where mem_no = #{mem_no}
    </update>

    <select id="selectManageInfo" parameterType="com.dalbit.menu.vo.SpecialDjManageVo" resultType="com.dalbit.menu.vo.SpecialDjManageVo">
        /* Men_Special.xml - selectManageInfo */
        select
            idx
            , title
            , select_year
            , select_month
            , notice_idx
            , DATE_FORMAT(req_start_date, '%Y-%m-%d') req_start_date
            , DATE_FORMAT(req_end_date, '%Y-%m-%d') req_end_date
            , DATE_FORMAT(condition_start_date, '%Y-%m-%d') condition_start_date
            , DATE_FORMAT(condition_end_date, '%Y-%m-%d') condition_end_date
            , condition_code1
            , condition_data1
            , condition_code2
            , condition_data2
            , condition_code3
            , condition_data3
            , condition_code4
            , condition_data4
            , best_code1
            , best_data1
            , best_code2
            , best_data2
            , best_code3
            , best_data3
            , is_view
            , platform
            , pc_image_url
            , mobile_image_url
            , DATE_FORMAT(reg_date, '%Y-%m-%d %H:%i:%s') reg_date
            , op_name
            , DATE_FORMAT(last_upd_date, '%Y-%m-%d %H:%i:%s') last_upd_date
            , last_op_name
            , round_no
        from rd_admin.tb_req_special_dj_manage
        where select_year = #{select_year}
            and select_month = #{select_month}
    </select>

    <select id="selectManageContentList" parameterType="com.dalbit.menu.vo.SpecialDjManageVo" resultType="com.dalbit.menu.vo.SpecialDjContentVo">
        /* Men_Special.xml - selectManageContentList */
        select
            content_type
            , image_pc_url
            , image_mobile_url
            , button_type
            , button_name
            , button_name_color
            , button_color
            , button_pc_link
            , button_mobile_link
        from rd_admin.tb_req_special_dj_content
        where select_year = #{select_year}
            and select_month = #{select_month}
        order by content_order asc
    </select>

    <insert id="insertManageInfo" parameterType="com.dalbit.menu.vo.SpecialDjManageVo">
        /* Men_Special.xml - insertManageInfo */
        insert into rd_admin.tb_req_special_dj_manage(
            title
            , select_year
            , select_month
            , notice_idx
            , req_start_date
            , req_end_date
            , condition_start_date
            , condition_end_date
            , condition_code1
            , condition_data1
            , condition_code2
            , condition_data2
            , condition_code3
            , condition_data3
            , condition_code4
            , condition_data4
            , best_code1
            , best_data1
            , best_code2
            , best_data2
            , best_code3
            , best_data3
            , is_view
            , platform
            , reg_date
            , op_name
            , round_no
        ) values (
            #{title}
            , #{select_year}
            , #{select_month}
            , #{notice_idx}
            , #{req_start_date}
            , DATE_FORMAT(#{req_end_date}, '%Y.%m.%d 23:59:59')
            , #{condition_start_date}
            , DATE_FORMAT(#{condition_end_date}, '%Y.%m.%d 23:59:59')
            , #{condition_code1}
            , #{condition_data1}
            , #{condition_code2}
            , #{condition_data2}
            , #{condition_code3}
            , #{condition_data3}
            , #{condition_code4}
            , #{condition_data4}
            , #{best_code1}
            , #{best_data1}
            , #{best_code2}
            , #{best_data2}
            , #{best_code3}
            , #{best_data3}
            , #{is_view}
            , #{platform}
            , now()
            , #{op_name}
            , #{round_no}
        )
    </insert>

    <update id="updateManageInfo" parameterType="com.dalbit.menu.vo.SpecialDjManageVo">
        /* Men_Special.xml - updateManageInfo */
        update rd_admin.tb_req_special_dj_manage
        set title = #{title}
            , notice_idx = #{notice_idx}
            , req_start_date = #{req_start_date}
            , req_end_date = DATE_FORMAT(#{req_end_date}, '%Y.%m.%d 23:59:59')
            , condition_start_date = #{condition_start_date}
            , condition_end_date = DATE_FORMAT(#{condition_end_date}, '%Y.%m.%d 23:59:59')
            , condition_code1 = #{condition_code1}
            , condition_data1 = #{condition_data1}
            , condition_code2 = #{condition_code2}
            , condition_data2 = #{condition_data2}
            , condition_code3 = #{condition_code3}
            , condition_data3 = #{condition_data3}
            , condition_code4 = #{condition_code4}
            , condition_data4 = #{condition_data4}
            , best_code1 = #{best_code1}
            , best_data1 = #{best_data1}
            , best_code2 = #{best_code2}
            , best_data2 = #{best_data2}
            , best_code3 = #{best_code3}
            , best_data3 = #{best_data3}
            , is_view = #{is_view}
            , platform = #{platform}
            , last_upd_date = now()
            , last_op_name = #{op_name}
            , round_no = #{round_no}
        where select_year = #{select_year}
            and select_month = #{select_month}
    </update>

    <delete id="deleteManageContent" parameterType="com.dalbit.menu.vo.SpecialDjManageVo">
        /* Men_Special.xml - deleteManageContent */
        delete
        from rd_admin.tb_req_special_dj_content
        where select_year = #{select_year}
            and select_month = #{select_month}
    </delete>

    <insert id="insertManageContent" parameterType="com.dalbit.menu.vo.SpecialDjContentVo">
        /* Men_Special.xml - deleteContent */
        insert into rd_admin.tb_req_special_dj_content(
            select_year
            , select_month
            , content_order
            , content_type
            , image_pc_url
            , image_mobile_url
            , button_type
            , button_name
            , button_name_color
            , button_color
            , button_pc_link
            , button_mobile_link
        )values(
            #{select_year, jdbcType=VARCHAR}
            , #{select_month, jdbcType=VARCHAR}
            , #{content_order, jdbcType=INTEGER}
            , #{content_type, jdbcType=VARCHAR}
            , #{image_pc_url, jdbcType=VARCHAR}
            , #{image_mobile_url, jdbcType=VARCHAR}
            , #{button_type, jdbcType=VARCHAR}
            , #{button_name, jdbcType=VARCHAR}
            , #{button_name_color, jdbcType=VARCHAR}
            , #{button_color, jdbcType=VARCHAR}
            , #{button_pc_link, jdbcType=VARCHAR}
            , #{button_mobile_link, jdbcType=VARCHAR}
        )
    </insert>

    <select id="selectManageList" parameterType="com.dalbit.menu.vo.SpecialDjManageVo" resultType="com.dalbit.menu.vo.SpecialDjManageVo">
        /* Men_Special.xml - selectManageList */
        select
            title
            , select_year
            , select_month
            , req_start_date
            , req_end_date
            , condition_start_date
            , condition_end_date
            , condition_code1
            , (select code from rd_data.tbl_code_define where type = 'special_dj_condition' and `value` = condition_code1) condition_codeName1
            , condition_data1
            , condition_code2
            , (select code from rd_data.tbl_code_define where type = 'special_dj_condition' and `value` = condition_code2) condition_codeName2
            , condition_data2
            , condition_code3
            , (select code from rd_data.tbl_code_define where type = 'special_dj_condition' and `value` = condition_code3) condition_codeName3
            , condition_data3
            , condition_code4
            , (select code from rd_data.tbl_code_define where type = 'special_dj_condition' and `value` = condition_code4) condition_codeName4
            , condition_data4
            , best_code1
            , (select code from rd_data.tbl_code_define where type = 'special_dj_condition' and `value` = best_code1) best_codeName1
            , best_data1
            , best_code2
            , (select code from rd_data.tbl_code_define where type = 'special_dj_condition' and `value` = best_code2) best_codeName2
            , best_data2
            , best_code3
            , (select code from rd_data.tbl_code_define where type = 'special_dj_condition' and `value` = best_code3) best_codeName3
            , best_data3
            , pc_image_url
            , mobile_image_url
            , is_view
            , platform
            , reg_date
            , op_name
            , last_upd_date
            , last_op_name
            , round_no
        from rd_admin.tb_req_special_dj_manage
        order by select_year desc, select_month desc
    </select>

    <sql id="reqAbleCondition">

        CASE
            WHEN list.condition_code1 = 1 THEN list.condition_data1 * 60 <![CDATA[<=]]> list.airTime
            WHEN list.condition_code1 = 2 THEN list.condition_data1 <![CDATA[<=]]> list.broadcastCnt
            WHEN list.condition_code1 = 3 THEN list.condition_data1 <![CDATA[<=]]> list.goodCnt + list.boostGoodCnt
            WHEN list.condition_code1 = 4 THEN list.condition_data1 <![CDATA[<=]]> list.level
            WHEN list.condition_code1 = 5 THEN list.condition_data1 <![CDATA[<=]]> list.fanCnt
            WHEN list.condition_code1 = 6 THEN list.condition_data1 <![CDATA[<=]]> list.allListenCnt
            WHEN list.condition_code1 = 7 THEN list.condition_data1 <![CDATA[<=]]> list.receiveStar
        END

        AND

        CASE
            WHEN list.condition_code2 = 1 THEN list.condition_data2 * 60 <![CDATA[<=]]> list.airTime
            WHEN list.condition_code2 = 2 THEN list.condition_data2 <![CDATA[<=]]> list.broadcastCnt
            WHEN list.condition_code2 = 3 THEN list.condition_data2 <![CDATA[<=]]> list.goodCnt + list.boostGoodCnt
            WHEN list.condition_code2 = 4 THEN list.condition_data2 <![CDATA[<=]]> list.level
            WHEN list.condition_code2 = 5 THEN list.condition_data2 <![CDATA[<=]]> list.fanCnt
            WHEN list.condition_code2 = 6 THEN list.condition_data2 <![CDATA[<=]]> list.allListenCnt
            WHEN list.condition_code2 = 7 THEN list.condition_data2 <![CDATA[<=]]> list.receiveStar
        END

        AND

        CASE
            WHEN list.condition_code3 = 1 THEN list.condition_data3 * 60 <![CDATA[<=]]> list.airTime
            WHEN list.condition_code3 = 2 THEN list.condition_data3 <![CDATA[<=]]> list.broadcastCnt
            WHEN list.condition_code3 = 3 THEN list.condition_data3 <![CDATA[<=]]> list.goodCnt + list.boostGoodCnt
            WHEN list.condition_code3 = 4 THEN list.condition_data3 <![CDATA[<=]]> list.level
            WHEN list.condition_code3 = 5 THEN list.condition_data3 <![CDATA[<=]]> list.fanCnt
            WHEN list.condition_code3 = 6 THEN list.condition_data3 <![CDATA[<=]]> list.allListenCnt
            WHEN list.condition_code3 = 7 THEN list.condition_data3 <![CDATA[<=]]> list.receiveStar
        END

        AND

        CASE
            WHEN list.condition_code4 = 1 THEN list.condition_data4 * 60 <![CDATA[<=]]> list.airTime
            WHEN list.condition_code4 = 2 THEN list.condition_data4 <![CDATA[<=]]> list.broadcastCnt
            WHEN list.condition_code4 = 3 THEN list.condition_data4 <![CDATA[<=]]> list.goodCnt + list.boostGoodCnt
            WHEN list.condition_code4 = 4 THEN list.condition_data4 <![CDATA[<=]]> list.level
            WHEN list.condition_code4 = 5 THEN list.condition_data4 <![CDATA[<=]]> list.fanCnt
            WHEN list.condition_code4 = 6 THEN list.condition_data4 <![CDATA[<=]]> list.allListenCnt
            WHEN list.condition_code4 = 7 THEN list.condition_data4 <![CDATA[<=]]> list.receiveStar
        END

        <if test='txt_search != null and txt_search != ""'>
            <choose>
                <when test="newSearchType == 1">
                    and list.mem_no = #{txt_search}
                </when>
                <when test="newSearchType == 2">
                    and list.mem_nick like concat('%', #{txt_search}, '%')
                </when>
                <when test="newSearchType == 3">
                    and list.mem_name = #{txt_search}
                </when>
                <when test="newSearchType == 4">
                    and list.mem_phone = #{txt_search}
                </when>
                <when test="newSearchType == 5">
                    and list.mem_id = #{txt_search}
                </when>
                <when test="newSearchType == 6">
                    and list.mem_no in (select distinct mem_no from rd_data.tb_member_connect_state where last_login_ip = #{txt_search})
                </when>
                <otherwise>
                    and list.mem_no in (SELECT distinct mem_no FROM rd_data.tb_member_session_history WHERE device_uuid = #{txt_search})
                </otherwise>
            </choose>
        </if>

        <!--<if test='txt_search != null and txt_search != ""'>
            <choose>
                <when test='searchType == "1"'>
                    and list.mem_no like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "2"'>
                    and list.mem_id like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "3"'>
                    and list.mem_nick like concat('%', #{txt_search}, '%')
                </when>
                <when test='searchType == "4"'>
                    and list.mem_phone like concat('%', #{txt_search}, '%')
                </when>
                <otherwise>
                    and (
                        list.mem_no like concat('%', #{txt_search}, '%')
                        or list.mem_id like concat('%', #{txt_search}, '%')
                        or list.mem_nick like concat('%', #{txt_search}, '%')
                        or list.mem_phone like concat('%', #{txt_search}, '%')
                    )
                </otherwise>
            </choose>
        </if>-->
    </sql>

    <select id="reqAbleSpecialDjList" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="com.dalbit.menu.vo.SpecialReqVo">
        /* Men_Special.xml - reqAbleSpecialDjList */
        select
            a.*
        from (
            select list.*
            from(
                select
                    basic.mem_no
                    , basic.mem_id
                    , basic.mem_sex
                    , basic.mem_nick
                    , basic.mem_phone
                    , basic.mem_birth_year
                    , basic.mem_birth_month
                    , basic.mem_birth_day
                    , basic.inner
                    , level.level
                    , manage.condition_code1
                    , manage.condition_data1
                    , manage.condition_code2
                    , manage.condition_data2
                    , manage.condition_code3
                    , manage.condition_data3
                    , manage.condition_code4
                    , manage.condition_data4
                    , ifnull((select TRUNCATE(ifnull(sum(airtime), 0) / 60, 0)
                                from rd_data.tb_broadcast_room room
                                where mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> start_date
                                and start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) airTime
                    , ifnull((select count(*)
                                from rd_data.tb_broadcast_room room
                                where mem_no = basic.mem_no
                                and 5400 <![CDATA[<=]]> airtime
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> start_date
                                and start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) broadcastCnt
                    , ifnull((select sum(good)
                                from rd_data.tb_member_broadcast_broadcasting
                                where mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                                and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) goodCnt
                    , ifnull((select sum(booster) * 10
                                from rd_data.tb_member_broadcast_broadcasting
                                where mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                                and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) boostGoodCnt
                    , ifnull((select count(*)
                                from rd_data.tb_member_fanstar
                                where mem_no_star = basic.mem_no), 0) fanCnt
                    , ifnull((select sum(listener)
                                from rd_data.tb_member_broadcast_broadcasting
                                where mem_no = basic.mem_no
                                    and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                                    and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) allListenCnt
                    , ifnull((select count(distinct listen.mem_no)
                                from rd_data.tb_member_broadcast_listening listen
                                where dj_mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> start_date
                                and start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) listenCnt
                    , ifnull((select count(*)
                                from rd_data.tb_member_report report
                                where reported_mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> report.reg_date
                                and report.reg_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) reportCnt
                    , ifnull((select sum(gold)
                                from rd_data.tb_member_broadcast_broadcasting broad
                                where broad.mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                                and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) receiveStar
                    , ifnull((select count(*)
                                from rd_data.tb_broadcast_room room
                                where basic.mem_no = room.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> room.start_date
                                and room.start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) broadCnt
                    , ifnull((select count(distinct listen.mem_no)
                                from rd_data.tb_member_broadcast_listening listen
                                where basic.mem_no = listen.dj_mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> listen.start_date
                                and listen.start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')
                                and 1800 <![CDATA[<=]]> listen.listentime), 0) listenCnt30
                from rd_data.tb_member_basic basic
                    inner join rd_data.tb_member_level level
                    , rd_admin.tb_req_special_dj_manage manage
                    , rd_data.tb_member_profile profile
                where basic.mem_no = level.mem_no
                    and manage.select_year = #{select_year}
                    and manage.select_month = #{select_month}
                    and basic.mem_no not in (select mem_no from rd_admin.tb_req_special_dj where DATE_FORMAT(reg_date, '%Y%m') = concat(#{select_year},#{select_month}))
                    and basic.mem_no = profile.mem_no
                    and profile.specialdj_cnt <![CDATA[<]]> 6
                /*order by level desc*/
            ) list
            where
                <include refid="reqAbleCondition" />
        ) a
        limit #{pageStart}, #{pageCnt}
    </select>

    <select id="reqAbleSpecialDjCnt" parameterType="com.dalbit.menu.vo.SpecialReqVo" resultType="int">
        /* Men_Special.xml - reqAbleSpecialDjCnt */
        select
            count(*)
        from (
            select list.*
            from(
                select
                    basic.inner
                    , basic.mem_no
                    , basic.mem_id
                    , basic.mem_nick
                    , basic.mem_phone
                    , level.level
                    , manage.condition_code1
                    , manage.condition_data1
                    , manage.condition_code2
                    , manage.condition_data2
                    , manage.condition_code3
                    , manage.condition_data3
                    , manage.condition_code4
                    , manage.condition_data4
                    , ifnull((select TRUNCATE(ifnull(sum(airtime), 0) / 60, 0)
                                from rd_data.tb_broadcast_room room
                                where mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> start_date
                                and start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) airTime
                    , ifnull((select count(*)
                                from rd_data.tb_broadcast_room room
                                where mem_no = basic.mem_no
                                and 5400 <![CDATA[<=]]> airtime
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> start_date
                                and start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) broadcastCnt
                    , ifnull((select count(*)
                                from rd_data.tb_broadcast_room_good good
                                where dj_mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                                and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) goodCnt
                    , ifnull((select sum(booster) * 10
                                from rd_data.tb_member_broadcast_broadcasting
                                where mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                                and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) boostGoodCnt
                    , ifnull((select count(*)
                                from rd_data.tb_member_fanstar
                                where mem_no_star = basic.mem_no), 0) fanCnt
                    , ifnull((select sum(listener)
                                from rd_data.tb_member_broadcast_broadcasting
                                where mem_no = basic.mem_no
                                    and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                                    and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) allListenCnt
                    , ifnull((select count(distinct listen.mem_no)
                                from rd_data.tb_member_broadcast_listening listen
                                where dj_mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> start_date
                                and start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) listenCnt
                    , ifnull((select count(*)
                                from rd_data.tb_member_report report
                                where reported_mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> report.reg_date
                                and report.reg_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) reportCnt
                    , ifnull((select sum(gold)
                                from rd_data.tb_member_broadcast_broadcasting broad
                                where broad.mem_no = basic.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> last_upd_date
                                and last_upd_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) receiveStar
                    , ifnull((select count(*)
                                from rd_data.tb_broadcast_room room
                                where basic.mem_no = room.mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> room.start_date
                                and room.start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')), 0) broadCnt
                    , ifnull((select count(distinct listen.mem_no)
                                from rd_data.tb_member_broadcast_listening listen
                                where basic.mem_no = listen.dj_mem_no
                                and DATE_FORMAT(manage.condition_start_date, '%Y-%m-%d 00:00:00') <![CDATA[<=]]> listen.start_date
                                and listen.start_date <![CDATA[<=]]> DATE_FORMAT(manage.condition_end_date, '%Y-%m-%d 23:59:59')
                                and 1800 <![CDATA[<=]]> listen.listentime), 0) listenCnt30
                from rd_data.tb_member_basic basic
                    , rd_data.tb_member_level level
                    , rd_admin.tb_req_special_dj_manage manage
                    , rd_data.tb_member_profile profile
                where basic.mem_no = level.mem_no
                    and manage.select_year = #{select_year}
                    and manage.select_month = #{select_month}
                    and basic.mem_no not in (select mem_no from rd_admin.tb_req_special_dj where DATE_FORMAT(reg_date, '%Y%m') = concat(#{select_year},#{select_month}))
                    and basic.mem_no = profile.mem_no
                    and profile.specialdj_cnt <![CDATA[<]]> 6
            ) list
            , (select @RNUM := 0) r
            where
                <include refid="reqAbleCondition" />
        ) a
    </select>

    <select id="callBestAbleList" statementType="CALLABLE"  parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.menu.vo.SpecialDjBestVo">
        call rd_admin.sp_admin_specialdj_best_able_list(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>

    <select id="callSpecialLeagueList" statementType="CALLABLE"  parameterType="com.dalbit.common.vo.ProcedureVo" resultType="com.dalbit.menu.vo.SpecialLeagueVo">
        call rd_admin.sp_admin_ranking_special_league(#{data, mode=IN, jdbcType=VARCHAR}, #{ret, mode=OUT, jdbcType=INTEGER}, #{ext, mode=OUT, jdbcType=VARCHAR})
    </select>
</mapper>